# See http://nginx.org/en/docs/hash.html
map_hash_bucket_size 256;

# Bots to ban via user agent
map $http_user_agent $limit_bots {
     default 0;
     ~*(AhrefsBot|YandexBot) 1;
}

# Set up redirects for known static URL-s
map $request_uri $is_scanner {
    default "";
    include /etc/nginx/redirects.map;
}

map $http_x_forwarded_proto $current_scheme {
     default $scheme;
     https https;
}  

server {
    listen       8080;
    server_name  localhost;
    
    # Ban certain bots from crawling the site
    if ($limit_bots = 1) {
        return 403;
    }

    include common-server.conf;

    # Send scanner bots/kiddies on a merry chase
    # We'll use an intermediate redirect, so we'll know later from logs
    # if the bot/scanner/kiddie actually follows redirects
    if ($is_scanner != "") {
      return 301 $current_scheme://$host/roll-them?why=$request_uri;
    }

    # Enjoy
    location /roll-them {
      return 301 https://www.youtube.com/watch?v=dQw4w9WgXcQ;
    }

    location / {
        root   /usr/share/nginx/html;
        index  index.html;
    
        # "Pretty" URL-s: don't require the .html file extension
        try_files $uri.html $uri $uri/index.html =404;
    }

    # with Content Security Policy (CSP) enabled(and a browser that supports it(http://caniuse.com/#feat=contentsecuritypolicy),
    # you can tell the browser that it can only download content from the domains you explicitly allow
    # http://www.html5rocks.com/en/tutorials/security/content-security-policy/
    # https://www.owasp.org/index.php/Content_Security_Policy
    # I need to change our application code so we can increase security by disabling 'unsafe-inline' 'unsafe-eval'
    # directives for css and js(if you have inline css or js, you will need to keep it too).
    # more: http://www.html5rocks.com/en/tutorials/security/content-security-policy/#inline-code-considered-harmful
    add_header Content-Security-Policy-Report-Only "default-src 'self'; script-src 'self' 'unsafe-inline'  https://ssl.google-analytics.com https://www.google-analytics.com https://members.internetdefenseleague.org; upgrade-insecure-requests; img-src 'self' https://members.internetdefenseleague.org; style-src 'self' 'unsafe-inline'  https://members.internetdefenseleague.org https://fonts.googleapis.com; font-src 'self' https://themes.googleusercontent.com https://fonts.gstatic.com; frame-src 'self'; object-src 'none'; report-uri https://sqroot.report-uri.com/r/d/csp/reportOnly;";

    add_header X-Want-To-Work-With "Cyber Security & HTTP API-s";
    add_header X-Recruitment "https://linkedin.com/in/anroots";
    add_header X-Powered-By "Jekyll";
    
    # Only some select HTTP methods are allowed
    if ($request_method !~ ^(GET|HEAD|OPTIONS)$ ) {
        return 405;
    }
}
